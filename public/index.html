<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>People Notes</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <style>
    /* Space out content a bit */
      body {
        padding-top: 20px;
        padding-bottom: 20px;
      }

      /* Everything but the jumbotron gets side spacing for mobile first views */
      .header,
      .marketing,
      .footer {
        padding-right: 15px;
        padding-left: 15px;
      }

      /* Custom page header */
      .header {
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e5e5;
      }
      /* Make the masthead heading the same height as the navigation */
      .header h3 {
        margin-top: 0;
        margin-bottom: 0;
        line-height: 40px;
      }

      /* Custom page footer */
      .footer {
        padding-top: 19px;
        color: #777;
        border-top: 1px solid #e5e5e5;
      }

      /* Customize container */
      @media (min-width: 768px) {
        .container {
          max-width: 730px;
        }
      }
      .container-narrow > hr {
        margin: 30px 0;
      }

      /* Main marketing message and sign up button */
      .jumbotron {
        text-align: center;
        border-bottom: 1px solid #e5e5e5;
      }
      .jumbotron .btn {
        padding: 14px 24px;
        font-size: 21px;
      }

      /* Supporting marketing content */
      .marketing {
        margin: 40px 0;
      }
      .marketing p + h4 {
        margin-top: 28px;
      }

      /* Responsive: Portrait tablets and up */
      @media screen and (min-width: 768px) {
        /* Remove the padding we set earlier */
        .header,
        .marketing,
        .footer {
          padding-right: 0;
          padding-left: 0;
        }
        /* Space out the masthead */
        .header {
          margin-bottom: 30px;
        }
        /* Remove the bottom border on the jumbotron for visual effect */
        .jumbotron {
          border-bottom: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- TODO: Use npm + webpack to install this locally and factor everything out. -->
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAHsBIF67mHchYUg0vtOtRpWw0r268-bZ8",
        authDomain: "simple-one-on-one.firebaseapp.com",
        databaseURL: "https://simple-one-on-one.firebaseio.com",
        storageBucket: "simple-one-on-one.appspot.com",
      };
      firebase.initializeApp(config);


      var provider = new firebase.auth.GoogleAuthProvider();

      var hideLogin = function() {
        console.log("Hiding login-box.")
        document.getElementById('login-box').style.display = "none";
      };

      var showLoggedInViewFromStore = function() {
        console.log("Showing logged in data view.");
        document.getElementById('nav-data-view').style.display = ""
        document.getElementById('data-view').style.display = ""

        for (var noteKey in store.data.notes) {
          var note = store.data.notes[noteKey];
          var noteDiv = document.createElement('div');
          noteDiv.className = "col-lg-12";
          noteDiv.innerHTML = "<h3>" + note.title + "</h3>"
                          + "<h6>" + new Date(note.timestamp) + "</h6>"
                          + "<p>" + note.message + "</p>";
          document.getElementById('data-view').appendChild(noteDiv);
        }
      }

      // DB for relevant state. Poor man's flux.
      var store = {}

      var login = function () {
        firebase.auth().signInWithPopup(provider)
          .then(function(result) {
            // The signed-in user info.
            store.user = result.user
            console.log(store.user)
            return store.user;
          })
          .catch(function(error) {
            alert("Unable to login. Please try again.");
            console.log(error);
          })
          .then(function(user) {
            return firebase.database().ref(user.uid).once("value");
          })
          .then(function(userData) {
            console.log(userData.val());
            store.data = userData.val();

            hideLogin();
            showLoggedInViewFromStore();
          })
          .catch(function(error) {
            alert("Unable to load user data.")
            console.log(error);
          });
      };
      
      var createNewNote = function(userId, title, message, peepId) {
        var timestamp = firebase.database.ServerValue.TIMESTAMP;
        var database = firebase.database();

        var newNoteKey = database.ref(userId).child("notes").push().key;

        var newNote = {
          "timestamp" : timestamp,
          "title" : title,
          "message" : message
        };
        if (peepId) {
          newNote["peep_id"] = peepId;
        }

        var updates = {}
        updates["/notes/" + newNoteKey] = newNote;

        database.ref(userId).update(updates)
          .then(function(result) {
            // Success + show.
          })
          .catch(function(error) {
            // Failure! hide.
          });
      }

      var launchCreateNoteModal = function() {
        // TODO: Launch a modal to create a note.
      }

    </script>
    

    <div class="container">
      <div class="header clearfix">
        <nav id="nav-data-view" style="display: none;">
          <ul class="nav nav-pills pull-right">
            <li role="presentation"><a href="#" onclick="launchCreateNoteModal()">Create Note</a></li>
          </ul>
        </nav>
        <h3 class="text-muted">People Manager</h3>
      </div>

      <div class="jumbotron" id="login-box">
        <h1>Welcome to People Manager</h1>
        <p class="lead">People manager allows you to view your notes about your team on two axis: (1) period of work or (2) individual history.</p>
        <p>Please login to access your people notes.</p>
        <p><a class="btn btn-lg btn-success" onclick="login()" role="button">Login with Google</a></p>
      </div>
      
      <div class="row marketing" id="data-view" style="display: none;">
      </div>

      <footer class="footer">
        <p>&copy; 2016 Matt Dailey</p>
      </footer>

    </div> <!-- /container -->
    
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Welcome to Firebase Hosting</title>
    <style media="screen">
      body {
        font-family: Roboto, Arial, sans-serif;
        background: #ECEFF1;
        color: rgba(0,0,0,0.87);
      }

      a {
        color: rgb(3,155,229);
      }

      .message {
        max-width: 400px;
        margin: 40px auto;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,0.2),0 1px 1px 0 rgba(0,0,0,0.14),0 2px 1px -1px rgba(0,0,0,0.12);
        border-radius: 2px;
        background: white;
        padding: 16px 24px;
      }

      .message h1 {
        font-size: 22px;
        font-weight: 500;
        text-align: center;
        margin: 0 0 16px;
      }

      .message p {
        font-weight: 300;
        line-height: 150%;
      }

      .message ul {
        list-style: none;
        margin: 16px 0 0;
        padding: 0;
        text-align: center;
      }

      .message li a {
        display: inline-block;
        padding: 8px;
        text-transform: uppercase;
        text-decoration: none;
        font-weight: 500;
        background: rgb(3,155,229);
        color: white;
        border: 1px solid rgb(3,155,229);
        border-radius: 3px;
        font-size: 14px;
        box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);
      }
    </style>
  </head>
  <body>
    <!-- TODO: Use npm + webpack to install this locally and factor everything out. -->
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAHsBIF67mHchYUg0vtOtRpWw0r268-bZ8",
        authDomain: "simple-one-on-one.firebaseapp.com",
        databaseURL: "https://simple-one-on-one.firebaseio.com",
        storageBucket: "simple-one-on-one.appspot.com",
      };
      firebase.initializeApp(config);


      var provider = new firebase.auth.GoogleAuthProvider();

      var hideLogin = function() {
        console.log("Hiding login-box.")
        document.getElementById('login-box').style.display = "none";
      };

      var showLoggedInViewFromStore = function() {
        console.log("Showing logged in data view.");
        var dataViewElement = document.getElementById('data-view')
        dataViewElement.style.display = "";
        
        for (var noteKey in store.data.notes) {
          var note = store.data.notes[noteKey];
          console.log(note)
          var noteDiv = document.createElement('div');
          noteDiv.className = "message";
          noteDiv.innerHTML = "<h1>" + note.title + "</h1>"
                          + "<p>" + note.message + "</p>";
          dataViewElement.appendChild(noteDiv);
        }
      }

      // DB for relevant state. Poor man's flux.
      var store = {}

      var login = function () {
        firebase.auth().signInWithPopup(provider)
          .then(function(result) {
            // The signed-in user info.
            store.user = result.user
            console.log(store.user)
            return store.user;
          })
          .catch(function(error) {
            alert("Unable to login. Please try again.");
            console.log(error);
          })
          .then(function(user) {
            return firebase.database().ref(user.uid).once("value");
          })
          .then(function(userData) {
            console.log(userData.val());
            store.data = userData.val();

            hideLogin();
            showLoggedInViewFromStore();
          })
          .catch(function(error) {
            alert("Unable to load user data.")
            console.log(error);
          });
      };
      
      var createNewNote = function(userId, title, message, peepId) {
        var timestamp = firebase.database.ServerValue.TIMESTAMP;
        var database = firebase.database();

        var newNoteKey = database.ref(userId).child("notes").push().key;

        var newNote = {
          "timestamp" : timestamp,
          "title" : title,
          "message" : message
        };
        if (peepId) {
          newNote["peep_id"] = peepId;
        }

        var updates = {}
        updates["/notes/" + newNoteKey] = newNote;

        database.ref(userId).update(updates)
          .then(function(result) {
            // Success + show.
          })
          .catch(function(error) {
            // Failure! hide.
          });
      }

    </script>
    <div class="message" id="login-box">
      <h1>Welcome to People Manager</h1>
      <p>People manager allows you to view your notes about your team on two axis: (1) period of work or (2) individual history.</p>
      <p>Please login to access your people notes.</p>
      <ul>
        <li><a target="_blank" onclick="login()">login with google</a></li>
      </ul>
    </div>
    <div id="data-view" style="display: none;">
    </div>
    
  </body>
</html>
